---
sidebar_position: 2
---

# SSL Termination

Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú¯Ø§Ù… Ø¨Ù‡ Ú¯Ø§Ù… Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ SSL Termination Ø¨Ø§ WaterWall! ğŸ”’âœ¨

## SSL Termination Ú†ÛŒØ³ØªØŸ ğŸ¤”

**SSL Termination** ÛŒØ¹Ù†ÛŒ **Ù¾Ø§ÛŒØ§Ù† SSL** - Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ SSL/TLS Ø®Ø§ØªÙ…Ù‡ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯:

```
Ú©Ø§Ø±Ø¨Ø± â”€â”€[HTTPS Ø§Ù…Ù†]â”€â”€> [SSL Termination] â”€â”€[HTTP Ø³Ø§Ø¯Ù‡]â”€â”€> Backend
```

### Ú†Ø±Ø§ SSL TerminationØŸ ğŸ¯

- ğŸš€ **Ú©Ø§Ù‡Ø´ Ø¨Ø§Ø±**: Backend Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ SSL processing Ù†Ø¯Ø§Ø±Ø¯
- ğŸ”§ **Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ø³Ø§Ù†**: Ú¯ÙˆØ§Ù‡ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± ÛŒÚ© Ù†Ù‚Ø·Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
- ğŸ“Š **Ø¨Ø±Ø±Ø³ÛŒ ØªØ±Ø§ÙÛŒÚ©**: Ø§Ù…Ú©Ø§Ù† monitoring Ùˆ logging
- âš¡ **Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ù‡ØªØ±**: Ú©Ø§Ù‡Ø´ CPU load Ø¯Ø± Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ backend

### Ù…Ø²Ø§ÛŒØ§ÛŒ WaterWall SSL Termination:
- ğŸƒ **Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§**: Ø¨Ù‡ØªØ± Ø§Ø² nginx Ø¯Ø± Ø¨Ø±Ø®ÛŒ scenarios
- ğŸ› ï¸ **Ø§Ù†Ø¹Ø·Ø§Ù**: Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯
- ğŸ”„ **Ù…Ù‚ÛŒØ§Ø³â€ŒÙ¾Ø°ÛŒØ±ÛŒ**: Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² connection pooling
- ğŸŒ **Ú†Ù†Ø¯ Ù¾Ø±ÙˆØªÚ©Ù„**: HTTP/1.1, HTTP/2, WebSocket

## Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§ ğŸ“‹

### 1. Ø¯Ø§Ù…Ù†Ù‡
Ø´Ù…Ø§ Ù†ÛŒØ§Ø² Ø¨Ù‡ ÛŒÚ© Ø¯Ø§Ù…Ù†Ù‡ Ø¯Ø§Ø±ÛŒØ¯:
- Ø¯Ø§Ù…Ù†Ù‡â€ŒÙ‡Ø§ÛŒ `.ir` Ø§Ø±Ø²Ø§Ù† Ùˆ Ù…Ù†Ø§Ø³Ø¨ Ù‡Ø³ØªÙ†Ø¯
- Ø¯Ø§Ù…Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† Ù…Ø§Ù†Ù†Ø¯ `.tk`, `.ml` Ù†ÛŒØ² Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯
- ÛŒØ§ Ø§Ø² Ø²ÛŒØ±Ø¯Ø§Ù…Ù†Ù‡ CloudFlare Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯

### 2. Ú¯ÙˆØ§Ù‡ÛŒ SSL
```bash
# Ù†ØµØ¨ certbot
sudo apt update
sudo apt install certbot

# Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙˆØ§Ù‡ÛŒ (Ø±ÙˆØ´ standalone)
sudo certbot certonly --standalone \
  --preferred-challenges http \
  --agree-tos \
  --email your-email@example.com \
  -d your-domain.com

# Ú¯ÙˆØ§Ù‡ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯:
ls -la /etc/letsencrypt/live/your-domain.com/
```

### 3. ØªÙ†Ø¸ÛŒÙ… Ø³Ø±ÙˆØ±
```bash
# Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
mkdir -p ~/waterwall-ssl/{configs,logs,ssl}
cd ~/waterwall-ssl

# Ú©Ù¾ÛŒ Ú¯ÙˆØ§Ù‡ÛŒâ€ŒÙ‡Ø§
sudo cp /etc/letsencrypt/live/your-domain.com/fullchain.pem ssl/
sudo cp /etc/letsencrypt/live/your-domain.com/privkey.pem ssl/
sudo chown $USER:$USER ssl/*.pem
```

## Ù†ÙˆØ¹ 1: SSL Termination Ø³Ø§Ø¯Ù‡ â­

### Ù†Ù…ÙˆØ¯Ø§Ø±
```mermaid
graph LR
    A[ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±<br/>HTTPS] --> B[ğŸ”’ WaterWall<br/>SSL Termination]
    B --> C[ğŸ–¥ï¸ Backend<br/>HTTP]
    
    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#e8f5e8
```

### Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ
```json title="configs/ssl-termination.json"
{
  "name": "ssl_termination_proxy",
  "author": "Ø´Ù…Ø§",
  "config-version": 1,
  "nodes": [
    {
      "name": "https_listener",
      "type": "TcpListener",
      "settings": {
        "address": "0.0.0.0",
        "port": 443,
        "nodelay": true,
        "fastopen": true
      },
      "next": "ssl_terminator"
    },
    {
      "name": "ssl_terminator",
      "type": "OpenSSLServer",
      "settings": {
        "cert-file": "ssl/fullchain.pem",     // Ù…Ø³ÛŒØ± Ú¯ÙˆØ§Ù‡ÛŒ
        "key-file": "ssl/privkey.pem",       // Ù…Ø³ÛŒØ± Ú©Ù„ÛŒØ¯ Ø®ØµÙˆØµÛŒ
        "alpns": ["http/1.1"],               // Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒâ€ŒØ´Ø¯Ù‡
        "session-ticket": true,              // Ø¨Ù‡Ø¨ÙˆØ¯ performance
        "session-timeout": 3600              // timeout session
      },
      "next": "backend_connector"
    },
    {
      "name": "backend_connector",
      "type": "TcpConnector",
      "settings": {
        "address": "127.0.0.1",             // Ø³Ø±ÙˆØ± backend
        "port": 8080,                       // Ù¾ÙˆØ±Øª HTTP backend
        "nodelay": true,
        "pool-size": 10                     // connection pool
      }
    }
  ]
}
```

### ØªØ³Øª
```bash
# Ø§Ø¬Ø±Ø§ÛŒ WaterWall
waterwall core.json

# ØªØ³Øª HTTPS
curl -k https://your-domain.com

# ØªØ³Øª Ø¨Ø§ curl verbose
curl -v -k https://your-domain.com

# Ø¨Ø±Ø±Ø³ÛŒ Ú¯ÙˆØ§Ù‡ÛŒ
openssl s_client -connect your-domain.com:443 -servername your-domain.com
```

## Ù†ÙˆØ¹ 2: SSL Termination Ø¨Ø§ HTTP/2 ğŸš€

### Ù†Ù…ÙˆØ¯Ø§Ø±  
```mermaid
graph LR
    A[ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±<br/>HTTP/2] --> B[ğŸ”’ WaterWall<br/>SSL + HTTP/2]
    B --> C[ğŸ–¥ï¸ Backend<br/>HTTP/1.1]
    
    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#e8f5e8
```

### Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ
```json title="configs/ssl-http2-termination.json"
{
  "name": "ssl_http2_termination",
  "author": "Ø´Ù…Ø§",
  "config-version": 1,
  "nodes": [
    {
      "name": "https_listener",
      "type": "TcpListener",
      "settings": {
        "address": "0.0.0.0",
        "port": 443,
        "nodelay": true,
        "fastopen": true,
        "reuseport": true
      },
      "next": "ssl_http2_terminator"
    },
    {
      "name": "ssl_http2_terminator",
      "type": "OpenSSLServer",
      "settings": {
        "cert-file": "ssl/fullchain.pem",
        "key-file": "ssl/privkey.pem",
        "alpns": [
          "h2",                              // HTTP/2 Ø§ÙˆÙ„ÙˆÛŒØª Ø§ÙˆÙ„
          "http/1.1"                         // HTTP/1.1 fallback
        ],
        "session-ticket": true,
        "session-timeout": 7200,
        "cipher-suites": "TLS_AES_256_GCM_SHA384"
      },
      "next": "http2_handler"
    },
    {
      "name": "http2_handler",
      "type": "Http2Server",
      "settings": {
        "host": "your-domain.com",
        "path": "/"
      },
      "next": "backend_connector"
    },
    {
      "name": "backend_connector",
      "type": "TcpConnector",
      "settings": {
        "address": "127.0.0.1",
        "port": 8080,
        "nodelay": true,
        "pool-size": 20,
        "pool-idle-timeout": 600
      }
    }
  ]
}
```

## Ù†ÙˆØ¹ 3: SSL Termination Ø¨Ø§ Load Balancing âš–ï¸

Ú†Ù†Ø¯ÛŒÙ† backend Ø±Ø§ Ù¾Ø´Øª SSL load balance Ú©Ù†ÛŒØ¯!

### Ù†Ù…ÙˆØ¯Ø§Ø±
```mermaid
graph LR
    A[ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±<br/>HTTPS] --> B[ğŸ”’ SSL Termination]
    B --> C1[ğŸ–¥ï¸ Backend 1]
    B --> C2[ğŸ–¥ï¸ Backend 2]
    B --> C3[ğŸ–¥ï¸ Backend 3]
```

### Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ
```json title="configs/ssl-load-balancer.json"
{
  "name": "ssl_load_balancer",
  "author": "Ø´Ù…Ø§",
  "config-version": 1,
  "nodes": [
    {
      "name": "https_listener",
      "type": "TcpListener",
      "settings": {
        "address": "0.0.0.0",
        "port": 443,
        "nodelay": true
      },
      "next": "ssl_terminator"
    },
    {
      "name": "ssl_terminator",
      "type": "OpenSSLServer",
      "settings": {
        "cert-file": "ssl/fullchain.pem",
        "key-file": "ssl/privkey.pem",
        "alpns": ["h2", "http/1.1"]
      },
      "next": "load_balancer_1"
    },
    {
      "name": "load_balancer_1",
      "type": "TcpConnector",
      "settings": {
        "address": "backend1.local",
        "port": 8080,
        "balance-group": "backends",
        "nodelay": true
      }
    },
    {
      "name": "load_balancer_2", 
      "type": "TcpConnector",
      "settings": {
        "address": "backend2.local",
        "port": 8080,
        "balance-group": "backends",
        "nodelay": true
      }
    },
    {
      "name": "load_balancer_3",
      "type": "TcpConnector", 
      "settings": {
        "address": "backend3.local",
        "port": 8080,
        "balance-group": "backends",
        "nodelay": true
      }
    }
  ]
}
```

## Ù†ÙˆØ¹ 4: SSL Termination Ø¨Ø§ Whitelist ğŸ›¡ï¸

ÙÙ‚Ø· IP Ù‡Ø§ÛŒ Ù…Ø¬Ø§Ø² Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯!

### Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ
```json title="configs/ssl-secure-termination.json"
{
  "name": "ssl_secure_termination",
  "author": "Ø´Ù…Ø§",
  "config-version": 1,
  "nodes": [
    {
      "name": "secure_https_listener",
      "type": "TcpListener",
      "settings": {
        "address": "0.0.0.0",
        "port": 443,
        "nodelay": true,
        "whitelist": [                       // ÙÙ‚Ø· Ø§ÛŒÙ† IP Ù‡Ø§
          "192.168.1.0/24",                 // Ø´Ø¨Ú©Ù‡ Ù…Ø­Ù„ÛŒ
          "10.0.0.0/8",                     // Ø´Ø¨Ú©Ù‡ Ø¯Ø§Ø®Ù„ÛŒ
          "1.2.3.4/32"                      // IP Ù…Ø®ØµÙˆØµ
        ],
        "blacklist": [                       // Ø§ÛŒÙ† IP Ù‡Ø§ Ù…Ù…Ù†ÙˆØ¹
          "5.6.7.8/32"
        ]
      },
      "next": "ssl_terminator"
    },
    {
      "name": "ssl_terminator",
      "type": "OpenSSLServer",
      "settings": {
        "cert-file": "ssl/fullchain.pem",
        "key-file": "ssl/privkey.pem",
        "alpns": ["http/1.1"],
        "verify-client": true,               // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª
        "client-ca-file": "ssl/client-ca.pem"
      },
      "next": "backend_connector"
    },
    {
      "name": "backend_connector",
      "type": "TcpConnector",
      "settings": {
        "address": "secure-backend.local",
        "port": 8443,                        // Backend Ù‡Ù… HTTPS
        "nodelay": true
      }
    }
  ]
}
```

## ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ âš™ï¸

### Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ SSL Performance
```json
{
  "name": "optimized_ssl_server",
  "type": "OpenSSLServer",
  "settings": {
    "cert-file": "ssl/fullchain.pem",
    "key-file": "ssl/privkey.pem",
    "alpns": ["h2", "http/1.1"],
    
    // Performance optimizations
    "session-ticket": true,                  // Ú©Ø´ session Ù‡Ø§
    "session-timeout": 7200,                 // Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ±
    "session-cache-size": 20480,             // Ø­Ø§ÙØ¸Ù‡ Ú©Ø´ Ø¨ÛŒØ´ØªØ±
    
    // Security settings
    "cipher-suites": "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256",
    "min-version": "TLSv1.2",                // Ø­Ø¯Ø§Ù‚Ù„ Ù†Ø³Ø®Ù‡ TLS
    "max-version": "TLSv1.3",                // Ø­Ø¯Ø§Ú©Ø«Ø± Ù†Ø³Ø®Ù‡ TLS
    
    // Connection settings
    "tcp-nodelay": true,
    "tcp-fastopen": true,
    "keepalive": true
  }
}
```

### Multi-Domain SSL (SNI)
```json
{
  "name": "multi_domain_ssl",
  "type": "OpenSSLServer",
  "settings": {
    "sni": {
      "domain1.com": {
        "cert-file": "ssl/domain1-fullchain.pem",
        "key-file": "ssl/domain1-privkey.pem"
      },
      "domain2.com": {
        "cert-file": "ssl/domain2-fullchain.pem", 
        "key-file": "ssl/domain2-privkey.pem"
      }
    },
    "alpns": ["h2", "http/1.1"]
  }
}
```

## Ù…Ø¯ÛŒØ±ÛŒØª Ú¯ÙˆØ§Ù‡ÛŒâ€ŒÙ‡Ø§ ğŸ“œ

### ØªÙ…Ø¯ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± Let's Encrypt
```bash
#!/bin/bash
# ssl-renew.sh

DOMAIN="your-domain.com"
WATERWALL_CONFIG_DIR="/home/user/waterwall-ssl"

# ØªÙ…Ø¯ÛŒØ¯ Ú¯ÙˆØ§Ù‡ÛŒ
sudo certbot renew --quiet

# Ú©Ù¾ÛŒ Ú¯ÙˆØ§Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
sudo cp "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" "$WATERWALL_CONFIG_DIR/ssl/"
sudo cp "/etc/letsencrypt/live/$DOMAIN/privkey.pem" "$WATERWALL_CONFIG_DIR/ssl/"
sudo chown $USER:$USER "$WATERWALL_CONFIG_DIR/ssl/"*.pem

# Ø±ÛŒØ³ØªØ§Ø±Øª WaterWall
pkill waterwall
sleep 2
cd "$WATERWALL_CONFIG_DIR"
nohup waterwall core.json > logs/waterwall.log 2>&1 &

echo "âœ… Ú¯ÙˆØ§Ù‡ÛŒ ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯ Ùˆ WaterWall Ø±ÛŒØ³ØªØ§Ø±Øª Ø´Ø¯"
```

### Crontab Ø¨Ø±Ø§ÛŒ ØªÙ…Ø¯ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±
```bash
# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ crontab
crontab -e

# ØªÙ…Ø¯ÛŒØ¯ Ù‡Ø± Ù…Ø§Ù‡
0 2 1 * * /path/to/ssl-renew.sh

# Ø¨Ø±Ø±Ø³ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡
0 2 * * * certbot renew --quiet --deploy-hook "/path/to/ssl-renew.sh"
```

### Ø§ÛŒØ¬Ø§Ø¯ Self-Signed Certificate (Ø¨Ø±Ø§ÛŒ ØªØ³Øª)
```bash
#!/bin/bash
# create-self-signed.sh

DOMAIN=${1:-localhost}
DAYS=${2:-365}

openssl req -x509 -newkey rsa:4096 \
  -keyout ssl/privkey.pem \
  -out ssl/fullchain.pem \
  -days $DAYS -nodes \
  -subj "/C=IR/ST=Tehran/L=Tehran/O=Test/CN=$DOMAIN"

chmod 600 ssl/privkey.pem
chmod 644 ssl/fullchain.pem

echo "âœ… Ú¯ÙˆØ§Ù‡ÛŒ self-signed Ø¨Ø±Ø§ÛŒ $DOMAIN Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯"
```

## Ù†Ø¸Ø§Ø±Øª Ùˆ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ ğŸ”§

### Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª SSL
```bash
# ØªØ³Øª Ø§ØªØµØ§Ù„ SSL
openssl s_client -connect your-domain.com:443 -servername your-domain.com

# Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§
openssl x509 -in ssl/fullchain.pem -text -noout | grep "Not After"

# ØªØ³Øª cipher suites
nmap --script ssl-enum-ciphers -p 443 your-domain.com

# ØªØ³Øª HTTP/2
curl -I --http2 https://your-domain.com
```

### Ù…Ø´Ú©Ù„Ø§Øª Ø±Ø§ÛŒØ¬

#### âŒ Ú¯ÙˆØ§Ù‡ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
```
Error: certificate verify failed
```
**Ø­Ù„**:
```bash
# Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
ls -la ssl/

# Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª Ú¯ÙˆØ§Ù‡ÛŒ
openssl x509 -in ssl/fullchain.pem -text -noout

# Ø¨Ø±Ø±Ø³ÛŒ ØªØ·Ø¨ÛŒÙ‚ Ø¯Ø§Ù…Ù†Ù‡
openssl x509 -in ssl/fullchain.pem -text -noout | grep -A1 "Subject Alternative Name"
```

#### âŒ Ú©Ù„ÛŒØ¯ Ø®ØµÙˆØµÛŒ Ø±Ù…Ø²Ø¯Ø§Ø±
```
Error: private key requires passphrase
```
**Ø­Ù„**:
```bash
# Ø­Ø°Ù Ø±Ù…Ø² Ø§Ø² Ú©Ù„ÛŒØ¯ Ø®ØµÙˆØµÛŒ
openssl rsa -in ssl/privkey.pem -out ssl/privkey-nopass.pem

# Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ù„ÛŒØ¯ Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø² Ø¯Ø± config
```

#### âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
```
Error: permission denied reading ssl files
```
**Ø­Ù„**:
```bash
# ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§
sudo chown $USER:$USER ssl/*.pem
chmod 600 ssl/privkey.pem
chmod 644 ssl/fullchain.pem
```

## Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù†ØµØ¨ Ø³Ø±ÛŒØ¹ ğŸš€

```bash
#!/bin/bash
# setup-ssl-termination.sh

DOMAIN=$1
EMAIL=$2
BACKEND_HOST=${3:-127.0.0.1}
BACKEND_PORT=${4:-8080}

if [ -z "$DOMAIN" ] || [ -z "$EMAIL" ]; then
    echo "Ø§Ø³ØªÙØ§Ø¯Ù‡: $0 <domain> <email> [backend_host] [backend_port]"
    echo "Ù…Ø«Ø§Ù„: $0 example.com admin@example.com 192.168.1.100 3000"
    exit 1
fi

echo "ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ SSL Termination Ø¨Ø±Ø§ÛŒ $DOMAIN..."

# Ù†ØµØ¨ certbot
sudo apt update
sudo apt install -y certbot

# Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙˆØ§Ù‡ÛŒ
sudo certbot certonly --standalone \
    --preferred-challenges http \
    --agree-tos \
    --email "$EMAIL" \
    -d "$DOMAIN"

# Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø§Ø®ØªØ§Ø± Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
mkdir -p ~/waterwall-ssl/{configs,logs,ssl}
cd ~/waterwall-ssl

# Ú©Ù¾ÛŒ Ú¯ÙˆØ§Ù‡ÛŒâ€ŒÙ‡Ø§
sudo cp "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ssl/
sudo cp "/etc/letsencrypt/live/$DOMAIN/privkey.pem" ssl/
sudo chown $USER:$USER ssl/*.pem

# Ø§ÛŒØ¬Ø§Ø¯ core.json
cat > core.json << EOF
{
  "log": {
    "path": "logs/",
    "core": {"loglevel": "INFO", "file": "core.log", "console": true}
  },
  "misc": {"workers": 0, "ram-profile": "server"},
  "configs": ["configs/ssl-termination.json"]
}
EOF

# Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ SSL termination
cat > configs/ssl-termination.json << EOF
{
  "name": "ssl_termination_${DOMAIN//./_}",
  "author": "SSL Setup Script",
  "config-version": 1,
  "nodes": [
    {
      "name": "https_listener",
      "type": "TcpListener",
      "settings": {
        "address": "0.0.0.0",
        "port": 443,
        "nodelay": true,
        "fastopen": true
      },
      "next": "ssl_terminator"
    },
    {
      "name": "ssl_terminator",
      "type": "OpenSSLServer",
      "settings": {
        "cert-file": "ssl/fullchain.pem",
        "key-file": "ssl/privkey.pem",
        "alpns": ["h2", "http/1.1"],
        "session-ticket": true,
        "session-timeout": 3600
      },
      "next": "backend_connector"
    },
    {
      "name": "backend_connector",
      "type": "TcpConnector",
      "settings": {
        "address": "$BACKEND_HOST",
        "port": $BACKEND_PORT,
        "nodelay": true,
        "pool-size": 10
      }
    }
  ]
}
EOF

echo "âœ… SSL Termination Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯!"
echo "ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ø±: ~/waterwall-ssl"
echo "ğŸš€ Ø§Ø¬Ø±Ø§: cd ~/waterwall-ssl && waterwall core.json"
echo "ğŸ§ª ØªØ³Øª: curl -I https://$DOMAIN"
```

## Ø®Ù„Ø§ØµÙ‡ ğŸ“‹

### Ú†Ú©â€ŒÙ„ÛŒØ³Øª SSL Termination
- [ ] Ø¯Ø§Ù…Ù†Ù‡ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ùˆ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø§Ø´Ø§Ø±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
- [ ] Ú¯ÙˆØ§Ù‡ÛŒ SSL Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡
- [ ] ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ SSL Ø¯Ø± Ù…Ø³ÛŒØ± ØµØ­ÛŒØ­ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ù†Ø¯
- [ ] Backend Ø³Ø±ÙˆØ± Ø±ÙˆÛŒ HTTP Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
- [ ] Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ WaterWall Ø¯Ø±Ø³Øª Ø§Ø³Øª
- [ ] ØªØ³Øª HTTPS Ù…ÙˆÙÙ‚ Ø§Ø³Øª

### Ù†Ú©Ø§Øª Ø·Ù„Ø§ÛŒÛŒ
```
session-ticket = true = Performance Ø¨Ù‡ØªØ±
HTTP/2 = Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§ØªØ±
Connection pooling = Ú©Ø§Ù‡Ø´ latency
Auto renewal = Ø¨Ø¯ÙˆÙ† ÙˆÙ‚ÙÙ‡
```

## Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ ğŸ¯

Ø­Ø§Ù„Ø§ Ú©Ù‡ SSL Termination Ø±Ø§ ØªØ³Ù„Ø· Ø¯Ø§Ø±ÛŒØ¯:

1. **[Load Balancing](load-balancing)** - Ú†Ù†Ø¯ÛŒÙ† backend Ø±Ø§ Ù…ØªØ¹Ø§Ø¯Ù„ Ú©Ù†ÛŒØ¯
2. **[Advanced Tunnels](advanced-tunnels/)** - ØªÙˆÙ†Ù„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡â€ŒØªØ± Ø¨Ø³Ø§Ø²ÛŒØ¯
3. **[Security Guide](../05-guides/security)** - Ø§Ù…Ù†ÛŒØª Ø±Ø§ ØªÙ‚ÙˆÛŒØª Ú©Ù†ÛŒØ¯
4. **[Performance Guide](../05-guides/performance)** - Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±Ø§ Ø¨Ù‡ÛŒÙ†Ù‡ Ú©Ù†ÛŒØ¯

**Ø¹Ø§Ù„ÛŒ! Ø­Ø§Ù„Ø§ Ø³Ø±ÙˆØ± Ø´Ù…Ø§ SSL Termination Ø¯Ø§Ø±Ø¯** ğŸ”’âœ¨

*"Ø§Ù…Ù†ÛŒØª Ø¨Ø¯ÙˆÙ† Ù¾ÛŒÚ†ÛŒØ¯Ú¯ÛŒØŒ Ù‚Ø¯Ø±Øª ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³Øª!"* ğŸ’ª
